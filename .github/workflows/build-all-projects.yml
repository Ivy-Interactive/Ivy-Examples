name: Build All Projects

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
  schedule:
    - cron: '0 6 * * *' # daily at 6 AM UTC

env:
  DOTNET_VERSION: '9.0.x'
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  check-ivy-version:
    name: Check Ivy Version
    runs-on: ubuntu-latest
    outputs:
      should-build: ${{ steps.check.outputs.should-build }}
      latest-version: ${{ steps.check.outputs.latest-version }}
      current-version: ${{ steps.check.outputs.current-version }}
      has-multiple-versions: ${{ steps.get-current.outputs.has-multiple-versions }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get latest Ivy version from NuGet
        id: get-latest
        run: |
          echo "Fetching latest Ivy version from NuGet..."
          IVY_VERSION=$(curl -s "https://api.nuget.org/v3-flatcontainer/ivy/index.json" \
            | grep -oE '"[0-9]+\.[0-9]+\.[0-9]+"' \
            | tail -1 | tr -d '"' || echo "")

          if [ -z "$IVY_VERSION" ]; then
            echo "Error: Could not fetch Ivy version"
            exit 1
          fi

          echo "Latest Ivy version: $IVY_VERSION"
          echo "latest-version=$IVY_VERSION" >> $GITHUB_OUTPUT

      - name: Get current Ivy version from csproj
        id: get-current
        run: |
          versions=$(find . -name "*.csproj" -not -path "*/bin/*" -not -path "*/obj/*" \
            | xargs grep -h -oE 'PackageReference Include="Ivy" Version="[^"]*"' 2>/dev/null \
            | grep -oE 'Version="[^"]*"' \
            | sed 's/Version="\(.*\)"/\1/' | sort -u)
          
          unique_versions=$(echo "$versions" | sort -u)
          unique_count=$(echo "$unique_versions" | grep -c . || echo "0")
      
          current_version=$(echo "$unique_versions" | head -1 | tr -d '\n' | tr -d '\r')
          
          if [ -z "$current_version" ]; then
            echo "current-version=unknown" >> $GITHUB_OUTPUT
            echo "has-multiple-versions=false" >> $GITHUB_OUTPUT
            echo "Current Ivy version: unknown"
          elif [ "$unique_count" -gt 1 ]; then
            echo "Current Ivy version: $current_version (multiple versions detected)"
            echo "Found versions: $(echo "$unique_versions" | tr '\n' ',' | sed 's/,$//')"
            echo "current-version=$current_version" >> $GITHUB_OUTPUT
            echo "has-multiple-versions=true" >> $GITHUB_OUTPUT
          else
            echo "Current Ivy version: $current_version"
            echo "current-version=$current_version" >> $GITHUB_OUTPUT
            echo "has-multiple-versions=false" >> $GITHUB_OUTPUT
          fi

      - name: Determine if build is needed
        id: check
        run: |
          latest="${{ steps.get-latest.outputs.latest-version }}"
          current="${{ steps.get-current.outputs.current-version }}"
          
          # Always build for PRs and manual triggers
          if [ "${{ github.event_name }}" == "push" ] || [ "${{ github.event_name }}" == "pull_request" ] || [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "should-build=true" >> $GITHUB_OUTPUT
            echo "latest-version=$latest" >> $GITHUB_OUTPUT
            echo "current-version=$current" >> $GITHUB_OUTPUT
          elif [ "$latest" != "$current" ]; then
            echo "should-build=true" >> $GITHUB_OUTPUT
            echo "latest-version=$latest" >> $GITHUB_OUTPUT
            echo "current-version=$current" >> $GITHUB_OUTPUT
          else
            echo "should-build=false" >> $GITHUB_OUTPUT
            echo "latest-version=$latest" >> $GITHUB_OUTPUT
            echo "current-version=$current" >> $GITHUB_OUTPUT
          fi

  discover-projects:
    name: Discover Projects
    runs-on: ubuntu-latest
    needs: check-ivy-version
    if: needs.check-ivy-version.outputs.should-build == 'true'
    outputs:
      projects: ${{ steps.find-projects.outputs.projects }}
      project-count: ${{ steps.find-projects.outputs.project-count }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name || github.repository }}
          ref: ${{ github.head_ref || github.ref_name }}

      - name: Find all .NET projects
        id: find-projects
        run: |
          projects=$(find . -name "*.csproj" -not -path "*/bin/*" -not -path "*/obj/*" | sort)
          project_array="["
          first=true
          while IFS= read -r project; do
            if [ "$first" = true ]; then
              first=false
            else
              project_array="$project_array,"
            fi
            dir_name=$(dirname "$project" | xargs basename)
            project_array="$project_array{\"path\":\"$project\",\"name\":\"$dir_name\"}"
          done <<< "$projects"
          project_array="$project_array]"
          project_count=$(echo "$projects" | wc -l)
          echo "projects=$project_array" >> $GITHUB_OUTPUT
          echo "project-count=$project_count" >> $GITHUB_OUTPUT

  build-projects:
    name: Build
    runs-on: ubuntu-latest
    needs: [check-ivy-version, discover-projects]
    if: needs.check-ivy-version.outputs.should-build == 'true' && needs.discover-projects.outputs.project-count > 0
    strategy:
      fail-fast: false
      matrix:
        project: ${{ fromJson(needs.discover-projects.outputs.projects) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name || github.repository }}
          ref: ${{ github.head_ref || github.ref_name }}

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Display .NET info
        run: dotnet --info

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore dependencies
        run: dotnet restore "${{ matrix.project.path }}"

      - name: Build project
        run: |
          echo "üî® Building: ${{ matrix.project.name }}"
          dotnet build "${{ matrix.project.path }}" \
            --configuration Release \
            --no-restore \
            --verbosity normal

      - name: Upload build artifacts (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ matrix.project.name }}
          path: |
            **/bin/**/*.log
            **/obj/**/*.log
          retention-days: 7

  detect-resolved-version:
    name: Detect Resolved Ivy Version
    runs-on: ubuntu-latest
    needs: [check-ivy-version, build-projects]
    if: needs.check-ivy-version.outputs.should-build == 'true' && (success() || failure())
    outputs:
      resolved-version: ${{ steps.get-version.outputs.resolved-version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name || github.repository }}
          ref: ${{ github.head_ref || github.ref_name }}

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Get resolved Ivy version
        id: get-version
        run: |
          echo "üîç Determining resolved Ivy version from packages..."
          project_file=$(find . -name "*.csproj" -not -path "*/bin/*" -not -path "*/obj/*" | head -1)
          if [ -n "$project_file" ]; then
            dotnet restore "$project_file" --verbosity quiet
            project_dir=$(dirname "$project_file")
            assets_file="$project_dir/obj/project.assets.json"
            if [ -f "$assets_file" ]; then
              # Extract Ivy version from project.assets.json
              # 1. Look at .libraries
              # 2. Filter entries where key starts with "Ivy/"
              # 3. Split key on "/" and take version part
              resolved_version=$(jq -r '.libraries | to_entries[] | select(.key | startswith("Ivy/")) | .key | split("/")[1]' "$assets_file" | head -1)
              if [ -n "$resolved_version" ] && [ "$resolved_version" != "null" ]; then
                echo "resolved-version=$resolved_version" >> $GITHUB_OUTPUT
              else
                echo "resolved-version=${{ needs.check-ivy-version.outputs.latest-version }}" >> $GITHUB_OUTPUT
              fi
            else
              echo "resolved-version=${{ needs.check-ivy-version.outputs.latest-version }}" >> $GITHUB_OUTPUT
            fi
          else
            echo "resolved-version=unknown" >> $GITHUB_OUTPUT
          fi

  update-ivy-version:
    name: Update Ivy Version
    runs-on: ubuntu-latest
    needs: check-ivy-version
    if: needs.check-ivy-version.outputs.should-build == 'true' && (needs.check-ivy-version.outputs.latest-version != needs.check-ivy-version.outputs.current-version || needs.check-ivy-version.outputs.has-multiple-versions == 'true')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Update Ivy version in csproj files
        run: |
          IVY_VERSION="${{ needs.check-ivy-version.outputs.latest-version }}"
          echo "Updating Ivy to version: $IVY_VERSION"

          for csproj in $(find . -name "*.csproj"); do
            if grep -q 'PackageReference Include="Ivy"' "$csproj"; then
              echo "Updating: $csproj"
              sed -i \
                "s|<PackageReference Include=\"Ivy\" Version=\"[^\"]*\"|<PackageReference Include=\"Ivy\" Version=\"$IVY_VERSION\"|g" \
                "$csproj"
            fi
          done

      - name: Commit changes if needed
        run: |
          if git diff --quiet; then
            echo "No changes to commit."
          else
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add .
            git commit -m "Update Ivy to version ${{ needs.check-ivy-version.outputs.latest-version }}"
            git push
          fi

  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [check-ivy-version, discover-projects, build-projects, detect-resolved-version]
    if: always() && needs.check-ivy-version.outputs.should-build == 'true'
    steps:
      - name: Generate build summary
        run: |
          echo "# üöÄ Ivy-Examples Build Summary" >> $GITHUB_STEP_SUMMARY
          resolved_version="${{ needs.detect-resolved-version.outputs.resolved-version }}"
          latest_version="${{ needs.check-ivy-version.outputs.latest-version }}"
          echo "## üì¶ Ivy Version Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Resolved Version:** $resolved_version" >> $GITHUB_STEP_SUMMARY
          echo "- **Latest Available:** $latest_version" >> $GITHUB_STEP_SUMMARY
          echo "**Total Projects:** ${{ needs.discover-projects.outputs.project-count }}" >> $GITHUB_STEP_SUMMARY
      - name: Set workflow status
        run: |
          if [ "${{ needs.build-projects.result }}" != "success" ]; then
            echo "‚ùå Build workflow failed"
            exit 1
          else
            echo "‚úÖ Build workflow succeeded"
          fi

  create-badge:
    name: Update Build Badge
    runs-on: ubuntu-latest
    needs: [check-ivy-version, build-summary, detect-resolved-version]
    if: github.ref == 'refs/heads/main' && always() && needs.check-ivy-version.outputs.should-build == 'true'
    steps:
      - name: Create build status badge
        run: |
          if [ "${{ needs.build-summary.result }}" == "success" ]; then
            echo "Build passing"
          else
            echo "Build failing"
          fi
